{"content":"<h1 id=\"33-行react剖析\">33 行&quot;React&quot;剖析</h1>\n<h2 id=\"源码链接\">源码链接</h2>\n<blockquote>\n<p>无注释： <a href=\"https://github.com/leontrolski/leontrolski.github.io/blob/master/33-line-react.js\">https://github.com/leontrolski/leontrolski.github.io/blob/master/33-line-react.js</a><br>有注释：<a href=\"https://github.com/leontrolski/leontrolski.github.io/blob/master/33-line-react-with-comments.js\">https://github.com/leontrolski/leontrolski.github.io/blob/master/33-line-react-with-comments.js</a></p>\n</blockquote>\n<h2 id=\"方法解析\">方法解析</h2>\n<p><strong>1. VNode 初始化</strong></p>\n<pre><code class=\"hljs js\"><span class=\"hljs-keyword\">const</span> m = <span class=\"hljs-function\">(<span class=\"hljs-params\">...args</span>) =&gt;</span> {\n  <span class=\"hljs-keyword\">let</span> [attrs, [head, ...tail]] = [{}, args];\n  <span class=\"hljs-comment\">// 第一个参数是VNode标签和className的组合：li.class1.class2</span>\n  <span class=\"hljs-keyword\">let</span> [tag, ...classes] = head.split(<span class=\"hljs-string\">&quot;.&quot;</span>);\n  <span class=\"hljs-comment\">// 第二个参数是VNode的属性，后面的其他的参数则是子元素</span>\n  <span class=\"hljs-comment\">// 判断第二个参数是不是一个合法的对象</span>\n  <span class=\"hljs-keyword\">if</span> (tail.length &amp;&amp; !m.isRenderable(tail[<span class=\"hljs-number\">0</span>])) [attrs, ...tail] = tail;\n  <span class=\"hljs-comment\">// 提取class写入classes，方便后续更新操作</span>\n  <span class=\"hljs-keyword\">if</span> (attrs.class) classes = [...classes, ...attrs.class];\n  attrs = { ...attrs };\n  <span class=\"hljs-keyword\">delete</span> attrs.class;\n  <span class=\"hljs-keyword\">const</span> children = [];\n  <span class=\"hljs-comment\">/**\n   * <span class=\"hljs-doctag\">@params <span class=\"hljs-type\">{any}</span> </span>v 子元素，VNode或者text\n   * 如果是null则不做操作\n   * 如果是数组则递归的初始化子元素\n   * 添加到childre\n   */</span>\n  <span class=\"hljs-keyword\">const</span> addChildren = <span class=\"hljs-function\">(<span class=\"hljs-params\">v</span>) =&gt;</span>\n    v === <span class=\"hljs-literal\">null</span>\n      ? <span class=\"hljs-literal\">null</span>\n      : <span class=\"hljs-built_in\">Array</span>.isArray(v)\n      ? v.map(addChildren)\n      : children.push(v);\n  addChildren(tail);\n  <span class=\"hljs-comment\">// 返回的VNode，__m标志通过m初始化的VNode</span>\n  <span class=\"hljs-keyword\">return</span> { <span class=\"hljs-attr\">__m</span>: <span class=\"hljs-literal\">true</span>, <span class=\"hljs-attr\">tag</span>: tag || <span class=\"hljs-string\">&quot;div&quot;</span>, attrs, classes, children };\n};\n</code></pre>\n<p>传入特定结构的数据，经过一系列操作之后，生成 Vnode，用例如下：</p>\n<pre><code class=\"hljs js\">m({\n  <span class=\"hljs-string\">&quot;div&quot;</span>,\n  {<span class=\"hljs-attr\">onClick</span>: <span class=\"hljs-function\">() =&gt;</span> {}},\n  <span class=\"hljs-string\">&quot;text&quot;</span>,\n  [\n    {\n      <span class=\"hljs-string\">&quot;div&quot;</span>,\n      {<span class=\"hljs-attr\">onClick</span>: <span class=\"hljs-function\">() =&gt;</span> {}},\n      <span class=\"hljs-string\">&quot;text&quot;</span>,\n    },\n    <span class=\"hljs-string\">&quot;text&quot;</span>\n  ]\n})\n</code></pre>\n<p><strong>2. render 挂载&amp;渲染</strong></p>\n<pre><code class=\"hljs js\">m.render = <span class=\"hljs-function\">(<span class=\"hljs-params\">parent, v</span>) =&gt;</span> {\n  <span class=\"hljs-comment\">// parent是真实的dom节点，v是m初始化后的VNode</span>\n  <span class=\"hljs-comment\">// 提取两个节点的子节点，用于比较，这里可以看出，m初始化的第一个元素没有进行挂载，可以传空字符</span>\n  <span class=\"hljs-keyword\">const</span> olds = parent.childNodes || [];\n  <span class=\"hljs-keyword\">const</span> news = v.children || [];\n  <span class=\"hljs-comment\">// 以新节点的长度为准，处理parent子节点列表的长度，保证小于等于新子节点列表长度</span>\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> _ <span class=\"hljs-keyword\">of</span> <span class=\"hljs-built_in\">Array</span>(<span class=\"hljs-built_in\">Math</span>.max(<span class=\"hljs-number\">0</span>, olds.length - news.length)))\n    parent.removeChild(parent.lastChild);\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> [i, child] <span class=\"hljs-keyword\">of</span> news.entries()) {\n    <span class=\"hljs-comment\">// 创建节点，索引对应的老节点不存在则创建新的节点</span>\n    <span class=\"hljs-keyword\">let</span> el = olds[i] || m.makeEl(child);\n    <span class=\"hljs-comment\">// 添加节点，索引对应的老节点不存在则在真实dom节点添加新节点</span>\n    <span class=\"hljs-keyword\">if</span> (!olds[i]) parent.appendChild(el);\n    <span class=\"hljs-comment\">// 替换节点，新旧节点都存在，则比较tagName</span>\n    <span class=\"hljs-keyword\">const</span> mismatch = (el.tagName || <span class=\"hljs-string\">&quot;&quot;</span>) !== (child.tag || <span class=\"hljs-string\">&quot;&quot;</span>).toUpperCase();\n    <span class=\"hljs-keyword\">if</span> (mismatch) (el = m.makeEl(child)) &amp;&amp; parent.replaceChild(el, olds[i]);\n    <span class=\"hljs-comment\">// 对节点进行更新操作</span>\n    m.update(el, child);\n    <span class=\"hljs-comment\">// 递归调用节点挂载操作</span>\n    m.render(el, child);\n  }\n};\n</code></pre>\n<p>m 是 function 也是对象，可直接在 m 上添加方法。<br>传入新旧两个节点，通过对比两个节点的异同，进行更新和渲染操作</p>\n<p><strong>3. update 更新</strong></p>\n<pre><code class=\"hljs js\">m.update = <span class=\"hljs-function\">(<span class=\"hljs-params\">el, v</span>) =&gt;</span> {\n  <span class=\"hljs-keyword\">if</span> (!v.__m) <span class=\"hljs-keyword\">return</span> el.data === <span class=\"hljs-string\">`<span class=\"hljs-subst\">${v}</span>`</span> || (el.data = v);\n  <span class=\"hljs-comment\">// 对比两个节点的classname列表，进行删减操作</span>\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> name <span class=\"hljs-keyword\">of</span> v.classes)\n    <span class=\"hljs-keyword\">if</span> (!el.classList.contains(name)) el.classList.add(name);\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> name <span class=\"hljs-keyword\">of</span> el.classList)\n    <span class=\"hljs-keyword\">if</span> (!v.classes.includes(name)) el.classList.remove(name);\n  <span class=\"hljs-comment\">// 对比两个节点的属性对象，进行属性替换操作</span>\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> name <span class=\"hljs-keyword\">of</span> <span class=\"hljs-built_in\">Object</span>.keys(v.attrs))\n    <span class=\"hljs-keyword\">if</span> (el[name] !== v.attrs[name]) el[name] = v.attrs[name];\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> { name } <span class=\"hljs-keyword\">of</span> el.attributes)\n    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-built_in\">Object</span>.keys(v.attrs).includes(name) &amp;&amp; name !== <span class=\"hljs-string\">&quot;class&quot;</span>)\n      el.removeAttribute(name);\n};\n</code></pre>\n<p>更新节点，则是对属性和 class 进行操作</p>\n<p><strong>4. 创建节点</strong></p>\n<pre><code class=\"hljs js\">m.makeEl = <span class=\"hljs-function\">(<span class=\"hljs-params\">v</span>) =&gt;</span>\n  v.__m ? <span class=\"hljs-built_in\">document</span>.createElement(v.tag) : <span class=\"hljs-built_in\">document</span>.createTextNode(v);\n</code></pre>\n<p><strong>5. 属性校验</strong></p>\n<pre><code class=\"hljs js\">m.isRenderable = <span class=\"hljs-function\">(<span class=\"hljs-params\">v</span>) =&gt;</span>\n  v === <span class=\"hljs-literal\">null</span> ||\n  [<span class=\"hljs-string\">&quot;string&quot;</span>, <span class=\"hljs-string\">&quot;number&quot;</span>].includes(<span class=\"hljs-keyword\">typeof</span> v) ||\n  v.__m ||\n  <span class=\"hljs-built_in\">Array</span>.isArray(v);\n</code></pre>\n<h2 id=\"用例\">用例</h2>\n<pre><code class=\"hljs html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span> <span class=\"hljs-attr\">lang</span>=<span class=\"hljs-string\">&quot;en&quot;</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">charset</span>=<span class=\"hljs-string\">&quot;UTF-8&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">http-equiv</span>=<span class=\"hljs-string\">&quot;X-UA-Compatible&quot;</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">&quot;IE=edge&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;viewport&quot;</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>Document<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;app&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span>&gt;</span><span class=\"javascript\">\n      <span class=\"hljs-comment\">// 此处省略了33行react的引入</span>\n      <span class=\"hljs-keyword\">const</span> vnode = m({\n        <span class=\"hljs-string\">&quot;div&quot;</span>,\n        {<span class=\"hljs-attr\">onClick</span>: <span class=\"hljs-function\">() =&gt;</span> {}},\n        <span class=\"hljs-string\">&quot;text&quot;</span>,\n        [\n          {\n            <span class=\"hljs-string\">&quot;div&quot;</span>,\n            {<span class=\"hljs-attr\">onClick</span>: <span class=\"hljs-function\">() =&gt;</span> {}},\n            <span class=\"hljs-string\">&quot;text&quot;</span>,\n          },\n          <span class=\"hljs-string\">&quot;text&quot;</span>\n        ]\n      })\n      m.render(<span class=\"hljs-built_in\">document</span>.getElementById(<span class=\"hljs-string\">&quot;app&quot;</span>), vnode)\n    </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span>\n</code></pre>\n","fileName":"lineReact"}